---
layout: post
title: "用 pytest 测试 python 代码"
keywords:
description:
category:
tags:
---

`Pytest` 是一个比较成熟且功能完备的 Python 测试框架。其提供完善的在线文档，并有着大量的第三方插件和内置帮助，适用于许多小型或大型项目。Pytest 灵活易学，打印调试和测试执行期间可以捕获标准输出，适合简单的单元测试到复杂的功能测试。还可以执行 nose, unittest 和 doctest 风格的测试用例，甚至 Django 和 trial。支持良好的集成实践， 支持扩展的 xUnit 风格 setup，支持非 python 测试。支持生成测试覆盖率报告，支持 PEP8 兼容的编码风格。

## 基本使用

```
usage: py.test [options] [file_or_dir] [file_or_dir] [...]
```

#### 用例查找规则

如果不带参数运行 pytest，那么其先从配置文件(pytest.ini，tox.ini，setup.cfg)中查找配置项 `testpaths` 指定的路径中的 test case，如果没有则从当前目录开始查找，否者，命令行参数就用于目录、文件查找。查找的规则如下：

- 查找指定目录中以 `test` 开头的目录
- 递归遍历目录，除非目录指定了不同递归
- 查找文件名以 `test_` 开头的文件
- 查找以 `Test` 开头的类(该类不能有 init 方法)
- 查找以 `test_` 开头的函数和方法并进行测试

如果要从默认的查找规则中忽略查找路径，可以加上 `--ingore` 参数，例如：

> pytest --ignore=tests/test_foobar.py

#### 调用 pytest

- py.test：

Pytest 提供直接调用的命令行工具，即 `py.test`，最新版本 `pytest` 和 `py.test` 两个命令行工具都可用

- python -m pytest：

效果和 `py.test` 一样, 这种调用方式在多 Python 版本测试的时候是有用的, 例如测试 Python3：

> python3 -m pytest [...] 

#### 部分参数解析

```
py.test --version               查看版本
py.test --fixtures, --funcargs  查看可用的 fixtures
pytest --markers                查看可用的 markers
py.test -h, --help              命令行和配置文件帮助

# 失败后停止
py.test -x           首次失败后停止执行
py.test --maxfail=2  两次失败之后停止执行

# 调试输出
py.test -l, --showlocals  在 traceback 中显示本地变量
py.test -q, --quiet       静默模式输出
py.test -v, --verbose     输出更详细的信息
py.test -s                捕获输出, 例如显示 print 函数的输出
py.test --tb=style        错误信息输出格式
    - long    默认的traceback信息格式化形式
    - native  标准库格式化形式
    - short   更短的格式
    - line    每个错误一行

# 失败时调用 PDB
py.test --pdb
```


#### 执行选择用例

- 执行单个模块中的全部用例:

> py.test test_mod.py  

- 执行指定路径下的全部用例:

> py.test somepath  

- 执行字符串表达式中的用例:

> py.test -k stringexpr

比如 "MyClass?and not method"，选择 TestMyClass.test_something，排除了TestMyClass.test_method_simple。

- 导入 package，使用其文件系统位置来查找和执行用例。执行 pkg 目录下的所有用例:

> py.test --pyargs pkg

- 运行指定模块中的某个用例，如运行 test_mod.py 模块中的 test_func 测试函数:

> pytest test_mod.py::test_func  

- 运行某个类下的某个用例，如运行 TestClass 类下的 test_method 测试方法:

> pytest test_mod.py::TestClass::test_method 


## 断言

通常情况下使用 `assert` 语句就能对大多数测试进行断言。对于异常断言，可以使用上下文管理器 `pytest.raises`：

```python
def test_zero_division():
    with pytest.raises(ZeroDivisionError):
        1 / 0
        
# 还可以捕获异常信息
def test_zero_division():
    with pytest.raises(ZeroDivisionError, message='integer division or modulo by zero'):
        1 / 0
```



```
pytest.approx
pytest.fail
pytest.skip
pytest.importorskip
pytest.xfail
pytest.exit
pytest.main
pytest.param
pytest.raises
pytest.deprecated_call
pytest.register_assert_rewrite
pytest.warns
```

对于自定义类型的 assert 比较断言，使用 pytest_assertrepr_compare 注册比较断言函数

如果想断言某些代码是否引发了异常，可以使用 raise helper，示例：



断言近似相等 pytest.approx

```
assert 2.2 == pytest.approx(2.3)
# fails, default is ± 2.3e-06
assert 2.2 == pytest.approx(2.3, 0.1)
# passes

# also works the other way, in case you were worried:
assert pytest.approx(2.3, 0.1) == 2.2
# passes
```


#### conftest.py
py.test 框架会在它测试的项目中寻找 conftest.py 文件，然后在这个文件中寻找针对整个项目的选项，比如是否检测并运行 doctest 以及应该使用哪种模式检测测试文件和函数。

## 添加命令行选项

```python
# content of conftest.py
import pytest

def pytest_addoption(parser):
    parser.addoption("--full", action="store_ture",
        help="run full test")
        
# content of test.py
@pytest.mark.skipif(not pytest.config.getoption("--runslow"))
def test_func_slow_1():
    print 'skip slow'
```

https://docs.pytest.org/en/latest/example/simple.html


## 跳过测试

```python
def setup_module(module):
    """py.test support"""
    import pytest
    pytest.skip("Pyglet and/or OpenGL are unavailable.")
```


```python
@pytest.mark.skipif(not os.getenv("TEST_ALL"), reason="running simple model")
def test_request_data(self):
    pass
```

## fixture

## markers

https://juejin.im/entry/597fdf276fb9a03c3f404837
https://cuyu.github.io/python/2016/09/21/Play-Python-Library%E4%B9%8Bpytest-mark%E7%AF%87

## 插件介绍

## 开始和结束时执行代码

http://stackoverflow.com/questions/22627659/run-code-before-and-after-each-test-in-py-test


https://docs.pytest.org/en/2.9.0/xunit_setup.html
https://docs.pytest.org/en/2.9.0/skipping.html
https://juejin.im/entry/597fdf276fb9a03c3f404837


## 参考资料

- [https://docs.pytest.org/en/latest/reference.html](https://docs.pytest.org/en/latest/reference.html)
- [http://www.voidcn.com/blog/wwq_1111/article/p-5791779.html](http://www.voidcn.com/blog/wwq_1111/article/p-5791779.html)
